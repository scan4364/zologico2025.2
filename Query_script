-- Codigo Gabriel Fonseca
ALTER TABLE Funcionario
ADD COLUMN email VARCHAR2;

CREATE UNIQUE INDEX idx_email ON Funcionario (email);

INSERT INTO Funcionario
VALUES (100,1000,200,2020-05-02,"Faxineiro",5000.00);

UPDATE Funcionario
SET email = josedafaxina@yahoo.com
WHERE id_pes = 100;

SELECT email FROM Funcionario
WHERE email LIKE 'j%';

SELECT tipo, salario FROM Funcionario
WHERE salario >= 4000;

SELECT email, salario FROM Funcionario
WHERE salario >= (SELECT AVG(salario) FROM Funcionario);

SELECT email FROM Funcionario
WHERE id_pes IN (
  SELECT id_pes
  FROM Funcionario
  WHERE tipo = 'Faxineiro'
);

DELETE FROM Funcionario
WHERE id_pes = 100;

SELECT FROM Funcionario
WHERE salario > ANY (SELECT salario FROM Funcionario WHERE data_admissao < 2025-01-01);

SELECT FROM Funcionario
WHERE salario > ALL (SELECT salario FROM Funcionario WHERE data_admissao > 2020-01-31);
-- END Codigo Gabriel Fonseca

-- Codigo celso Anjos
CREATE TABLE Audi_Funci(
    audi_id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
	funId INT,
    nome VARCHAR2(255),
	data_aud DATE 
);

SELECT *
FROM Ingresso
WHERE TO_CHAR(data, 'YYYY') LIKE '2025';

SELECT 
    a.id_animal,
    a.nome AS nome_animal,
    h.cod AS habitat_id,
    h.nome AS habitat_nome
FROM Animal a
LEFT JOIN Habitat h ON a.id_habitat = h.cod;

ALTER TABLE Audi_Funci
ADD descricao VARCHAR2(255);

CREATE VIEW Audi_Funci_Hora AS 
	SELECT 
		F.id_pes AS id_pes,
		P.nome AS nome, 
		SYSDATE AS data_hora_acesso 
		FROM Funcionario F
		INNER JOIN Pessoa P ON F.id_pes = P.id_pessoa; 
    

INSERT INTO Audi_Funci(funId, nome, data_aud) 
	SELECT 
    	id_pes,
    	nome,
    	data_hora_acesso
    FROM Audi_Funci_Hora;

CREATE OR REPLACE TRIGGER trg_audi_funci_all
AFTER INSERT OR UPDATE OR DELETE ON Funcionario
FOR EACH ROW
BEGIN

  IF INSERTING THEN
    INSERT INTO Audi_Funci(funId, nome, data_aud, descricao)
    VALUES(
      :NEW.id_pes,
      NVL((SELECT nome FROM Pessoa WHERE id_pessoa = :NEW.id_pes), 'NOME_NAO_ENCONTRADO'),
      SYSDATE,
      'INSERT'
    );
  END IF;

  IF UPDATING THEN
    INSERT INTO Audi_Funci(funId, nome, data_aud, descricao)
    VALUES(
      :NEW.id_pes,
      NVL((SELECT nome FROM Pessoa WHERE id_pessoa = :NEW.id_pes), 'NOME_NAO_ENCONTRADO'),
      SYSDATE,
      'UPDATE'
    );
  END IF;

  IF DELETING THEN
    INSERT INTO Audi_Funci(funId, nome, data_aud, descricao)
    VALUES(
      :OLD.id_pes,
      NVL((SELECT nome FROM Pessoa WHERE id_pessoa = :OLD.id_pes), 'NOME_NAO_ENCONTRADO'),
      SYSDATE,
      'DELETE'
    );
  END IF;
END;
/

SELECT nome from Pessoa P
	INNER JOIN Funcionario V ON P.id_pessoa = V.id_pes
	ORDER BY nome ASC;

SELECT COUNT(*) FROM Animal 
	GROUP BY idade
	HAVING COUNT(*) < 1;

SELECT COUNT(*) AS Quatidade FROM Animal 

SELECT 'Mais Velho' AS tipo, nome, data_nascimento
FROM Pessoa
WHERE data_nascimento = (SELECT MIN(data_nascimento) FROM Pessoa)
UNION ALL
SELECT 'Mais Novo' AS tipo, nome, data_nascimento
FROM Pessoa
WHERE data_nascimento = (SELECT MAX(data_nascimento) FROM Pessoa); 

SELECT 
    AVG(TRUNC(MONTHS_BETWEEN(SYSDATE, data_nascimento) / 12)) AS idade_media
FROM Pessoa;

SELECT *
FROM Ingresso
WHERE 
    data_compra BETWEEN DATE '2024-01-01' AND DATE '2024-12-31'
    AND forma_pagamento IN (
        SELECT forma_pagamento
        FROM Ingresso
        WHERE forma_pagamento IN ('Dinheiro', 'Cartão', 'PIX')
    );

SELECT forma_pagamento, COUNT(*) AS total_vendas
FROM Ingresso
GROUP BY forma_pagamento

CREATE OR REPLACE TYPE tipo_animal_record AS OBJECT (
    id_animal   NUMBER,
    nome        VARCHAR2(255),
    habitat     VARCHAR2(255)
);
/


CREATE OR REPLACE TYPE tipo_animais_table AS TABLE OF tipo_animal_record;
/


CREATE OR REPLACE FUNCTION fn_qtd_animais_habitat(p_id_habitat NUMBER)
RETURN NUMBER
IS
    v_qtd NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_qtd FROM Animal WHERE id_habitat = p_id_habitat;
    RETURN v_qtd;
END;
/

CREATE OR REPLACE PROCEDURE prc_listar_animais_por_habitat(
    p_id_habitat IN NUMBER,
    p_result OUT tipo_animais_table
)
IS
BEGIN
    p_result := tipo_animais_table(); 

    FOR reg IN (
        SELECT a.id_animal, a.nome AS nome_animal, h.nome AS nome_habitat
        FROM Animal a
        LEFT JOIN Habitat h ON a.id_habitat = h.cod
        WHERE a.id_habitat = p_id_habitat
    ) LOOP
        p_result.EXTEND;
        p_result(p_result.LAST) := tipo_animal_record(reg.id_animal, reg.nome_animal, reg.nome_habitat);
    END LOOP;
END;
/
HAVING COUNT(*) < 2;

SELECT *
FROM Ingresso
WHERE data IS NOT NULL;

-- ==========================================================
-- ADIÇÕES: CONSULTAS USANDO CASE WHEN
-- ==========================================================

-- Classificar Funcionários por Faixa Salarial
-- ----------------------------------------------------------
-- Mostra o nome do funcionário, salário e sua faixa salarial.
SELECT 
    P.nome AS nome_funcionario,
    F.salario,
    CASE 
      WHEN F.salario >= 8000 THEN 'Alto'
      WHEN F.salario BETWEEN 8000 AND 4000 THEN 'Medio'
      ELSE 'Baixo'
    END AS faixa_salarial
FROM Funcionario F
INNER JOIN Pessoa P ON F.id_pes = P.id_pessoa;

-- Classificar Animais por Faixa Etária
-- ----------------------------------------------------------
-- Mostra o nome do animal e sua idade.
SELECT 
    A.nome AS nome_animal,
    A.idade,
    CASE 
      WHEN A.idade <= 2 THEN 'Jovem'
      WHEN A.idade BETWEEN 2 AND 10 THEN 'Adulto'
      ELSE 'Idoso'
    END AS faixa_etaria
FROM Animal A;

-- Classificar Estágios por Status Atual
-- ----------------------------------------------------------
-- Indica se um estágio está ativo, finalizado ou em andamento.
SELECT 
    E.cod,
    P.nome AS nome_estagiario,
    E.data_inicio,
    E.data_fim,
    CASE 
      WHEN E.data_fim IS NULL THEN 'Em Andamento'
      WHEN E.data_fim < SYSDATE THEN 'Finalizado'
      ELSE 'Ativo'
    END AS status_estagio
FROM Estagio E
INNER JOIN Estagiario ES ON E.id_estagiario = ES.id_func
INNER JOIN Pessoa P ON F.id_func = P.id_pessoa;

-- Classificar Ingressos por Faixa de Valor
-- ----------------------------------------------------------
-- Mostra o tipo de pagamento e classifica os ingressos conforme o valor.
SELECT 
    I.cod AS codigo_ingresso,
    I.forma_pagamento,
    I.valor,
    CASE
        WHEN I.valor < 30 THEN 'Baixo Custo'
        WHEN I.valor BETWEEN 30 AND 60 THEN 'Médio Custo'
        ELSE 'Alto Custo'
    END AS faixa_preco
FROM Ingresso I
ORDER BY I.valor;

-- Determinar a situação da supervisão do Funcionário
-- ----------------------------------------------------------
-- Mostra se o funcionário possui ou não supervisor.
SELECT 
    P.nome AS nome_funcionario,
    CASE 
      WHEN F.id_supervisor IS NULL THEN 'Sem supervisor'
      ELSE 'Com supervisor'
    END AS situacao_supervisao
FROM Funcionario F
INNER JOIN Pessoa P ON F.id_pes = P.id_pessoa
ORDER BY situacao_supervisao;

